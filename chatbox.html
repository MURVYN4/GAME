<script>
/* ---------- Chatbox Return Helper (drop-in) ---------- */
(function () {
  // 1) Read return URL from ?return=, #return=, or data-return on <body>
  function readReturnURL() {
    const qs = new URLSearchParams(location.search).get("return");
    if (qs) return qs;                       // already decoded by URLSearchParams
    const hash = location.hash.match(/(?:^|[?#&])return=([^&]+)/i);
    if (hash) return decodeURIComponent(hash[1]);
    const el = document.body?.dataset?.return;
    return el || "";
  }

  const RETURN_URL = readReturnURL();

  // 2) Build a “Back to Game” button if one doesn’t exist
  function ensureBackButton() {
    if (document.getElementById("backToGame")) return;
    const btn = document.createElement("button");
    btn.id = "backToGame";
    btn.textContent = "⟵ Back to Game";
    btn.style.cssText = [
      "position:fixed","right:12px","bottom:12px","padding:8px 12px",
      "border:0","border-radius:999px","background:#111827","color:#fff",
      "font:600 14px system-ui","box-shadow:0 6px 18px rgba(0,0,0,.25)",
      "cursor:pointer","z-index:9999"
    ].join(";");
    btn.addEventListener("click", goBackToGame);
    document.body.appendChild(btn);
  }

  // 3) Go-back logic (close → history → redirect → alert)
  function goBackToGame() {
    // If opened from a course window/tab
    if (window.opener && !window.opener.closed) {
      try { window.opener.focus(); } catch(_) {}
      try { window.open('', '_self'); window.close(); } catch(_) {}
      return;
    }
    // If navigated from a course in same tab
    if (document.referrer || history.length > 1) {
      history.back();
      return;
    }
    // If we have an explicit return URL
    if (RETURN_URL) {
      location.href = RETURN_URL;
      return;
    }
    alert("Please switch back to your course tab/window.");
  }

  // 4) Keyboard shortcut (Esc to go back)
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") goBackToGame();
  });

  // 5) Expose simple helpers
  window.ChatboxReturn = {
    // Generate a link you can paste into iSpring (auto-encodes):
    makeLink(chatboxUrl, courseUrl) {
      const enc = encodeURIComponent(courseUrl);
      return `${chatboxUrl}${chatboxUrl.includes("?") ? "&" : "?"}return=${enc}`;
    },
    // Programmatically set/override the return URL:
    set(url) { document.body.dataset.return = url; }
  };

  // Init
  ensureBackButton();
})();
</script>
