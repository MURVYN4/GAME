<!DOCTYPE html>
<html>
<head>
  <title>My Quiz Presentation Game</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden; background-color: #000;
      font-family: Arial, sans-serif;
    }
    #loginScreen, #leaderboard {
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      height: 100%; width: 100%; background: #111; color: white;
      position: absolute; top: 0; left: 0;
    }
    #gameScreen {
      display: none;
      height: 100%; width: 100%;
      position: absolute; top: 0; left: 0;
    }
    iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
    }
    input, button { padding: 10px; font-size: 16px; margin: 5px; }
    table { border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid white; padding: 8px; }
    th { background: #333; }
    /* Overlays */
    #finishBtn { position: absolute; top: 10px; right: 10px; padding: 10px; z-index: 10; }
    #timerDisplay {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 8px 12px; border-radius: 8px; font-size: 18px; z-index: 10;
    }
    /* Fallback manual trigger (optional) */
    #startTimerBtn {
      position: absolute; top: 10px; left: 10px;
      z-index: 11;
      background: #39d6f4; color: #001018; border: none; cursor: pointer;
      font-weight: 700; border-radius: 8px; box-shadow: 0 4px 0 #0a2c36;
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <h1>Enter Your Name to Start</h1>
  <input type="text" id="username" placeholder="Your name">
  <button onclick="startGame()">Enter</button>
</div>

<!-- Game Screen -->
<div id="gameScreen">
  <!-- Fallback Start button (you can delete if youâ€™ll only use iSpring trigger) -->
  <button id="startTimerBtn" title="Fallback: start timer manually">Start Timer</button>

  <!-- Live timer -->
  <div id="timerDisplay">Time: 0.0s</div>

  <!-- Your iSpring/Office iframe -->
  <iframe src="https://pisedumy-my.sharepoint.com/personal/09dem22f1022_student_pis_edu_my/_layouts/15/Doc.aspx?sourcedoc={a45aad04-6600-4f59-9b46-978b1047ba33}&amp;action=embedview&amp;wdAr=1.7777777777777777" width="476px" height="288px" frameborder="0">This is an embedded <a target="_blank" href="https://office.com">Microsoft Office</a> presentation, powered by <a target="_blank" href="https://office.com/webapps">Office</a>.</iframe>

  <button id="finishBtn" onclick="finishGame()">Finish</button>
</div>

<!-- Leaderboard Screen -->
<div id="leaderboard" style="display:none;">
  <h1>Leaderboard</h1>
  <table id="leaderboardTable">
    <tr><th>Rank</th><th>Name</th><th>Time (sec)</th></tr>
  </table>
</div>

<script>
/* ================= TIMER ================= */
let startTime = null;
let timerInterval = null;
let timerRunning = false;

function startTimer() {
  if (timerRunning) return;
  timerRunning = true;
  startTime = Date.now();
  const t = document.getElementById("timerDisplay");
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    t.textContent = `Time: ${elapsed}s`;
  }, 100);
}

function stopTimerAndGetSeconds() {
  if (!timerRunning || !startTime) return 0;
  clearInterval(timerInterval);
  timerRunning = false;
  const total = ((Date.now() - startTime) / 1000).toFixed(2);
  return parseFloat(total);
}
/* ========================================= */

function startGame() {
  const name = document.getElementById("username").value.trim();
  if (!name) { alert("Please enter your name!"); return; }
  localStorage.setItem("currentPlayer", name);
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  // Timer will start via iSpring message OR the fallback button.
}

/* Fallback button (optional) */
document.getElementById("startTimerBtn").addEventListener("click", () => {
  startTimer();
  document.getElementById("startTimerBtn").style.display = "none";
});

/* Leaderboard helpers */
function saveToLeaderboard(name, seconds) {
  let savedPlayers = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  savedPlayers.push({ name, time: seconds });
  savedPlayers.sort((a, b) => a.time - b.time);
  localStorage.setItem("leaderboard", JSON.stringify(savedPlayers));
  return savedPlayers;
}

function finishGame() {
  const name = localStorage.getItem("currentPlayer") || "Player";
  const totalTime = stopTimerAndGetSeconds();
  const savedPlayers = saveToLeaderboard(name, totalTime);

  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("leaderboard").style.display = "flex";

  const table = document.getElementById("leaderboardTable");
  table.innerHTML = "<tr><th>Rank</th><th>Name</th><th>Time (sec)</th></tr>";
  savedPlayers.forEach((player, index) => {
    const row = table.insertRow();
    row.insertCell(0).innerText = index + 1;
    row.insertCell(1).innerText = player.name;
    row.insertCell(2).innerText = player.time.toFixed(2);
  });
}

/* ====== NEW: Listen for iSpring triggers via postMessage ======
   From slide 11's click that jumps to slide 25, have iSpring send:
   window.parent.postMessage({ startTimer: true }, "*");
   And on the final slide:
   window.parent.postMessage({ finishTimer: true }, "*");
*/
window.addEventListener("message", (e) => {
  const data = e.data || {};
  // If your iSpring is hosted on your own domain, add an origin check here.
  if (data.startTimer) {
    startTimer();
    const btn = document.getElementById("startTimerBtn");
    if (btn) btn.style.display = "none";
  }
  if (data.finishTimer) {
    // Stop and optionally auto-finish
    const total = stopTimerAndGetSeconds();
    console.log("Timer stopped via iSpring:", total, "seconds");
    // Auto-show leaderboard (uncomment if you want this behavior)
    // finishGame();
  }
});
/* ============================================================= */
</script>

</body>
</html>
